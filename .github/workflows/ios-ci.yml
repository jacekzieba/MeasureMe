name: iOS CI

on:
  push:
    branches:
      - main
      - master
      - 'codex/**'
  pull_request:

jobs:
  build-and-test:
    name: Build & Test (iOS ${{ matrix.ios_runtime }})
    runs-on: macos-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        ios_runtime:
          - "18.0"
          - "26.1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Detect changed Swift files
        id: changed_swift
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          BEFORE_SHA: ${{ github.event.before }}
        run: |
          set -euo pipefail

          if [ "$EVENT_NAME" = "pull_request" ] && [ -n "${PR_BASE_SHA:-}" ]; then
            BASE_SHA="$PR_BASE_SHA"
          else
            BASE_SHA="${BEFORE_SHA:-}"
          fi

          if [ -z "${BASE_SHA:-}" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="$(git rev-list --max-parents=0 HEAD)"
          fi

          if ! git cat-file -e "$BASE_SHA^{commit}" 2>/dev/null; then
            git fetch --no-tags --depth=1 origin "$BASE_SHA" || true
          fi

          CHANGED_SWIFT_FILES="$(git diff --name-only "$BASE_SHA" "$GITHUB_SHA" -- '*.swift')"
          {
            echo "files<<EOF"
            echo "$CHANGED_SWIFT_FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: SwiftLint changed files (blocking)
        run: |
          set -euo pipefail
          FILES="${{ steps.changed_swift.outputs.files }}"
          if [ -z "$FILES" ]; then
            echo "No changed Swift files to lint."
            exit 0
          fi

          while IFS= read -r file; do
            [ -n "$file" ] || continue
            echo "Linting $file"
            swiftlint lint --config .swiftlint.yml --strict --path "$file"
          done <<< "$FILES"

      - name: SwiftLint full report (non-blocking)
        continue-on-error: true
        run: swiftlint lint --config .swiftlint.yml --reporter github-actions-logging

      - name: Select Xcode 26.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.2"

      - name: Resolve simulator destination
        id: destination
        env:
          REQUESTED_IOS: ${{ matrix.ios_runtime }}
        run: |
          set -euo pipefail

          SHOW_DESTINATIONS="$(xcodebuild -project MeasureMe.xcodeproj -scheme MeasureMe -showdestinations)"

          DESTINATION="$(printf '%s\n' "$SHOW_DESTINATIONS" | awk -F'[{}]' -v requested="$REQUESTED_IOS" '
            /platform:iOS Simulator/ {
              line = $2
              gsub(/, /, ",", line)
              gsub(/^ +| +$/, "", line)
              if (line ~ ("OS:" requested "(,|$)")) {
                print line
                exit
              }
            }
          ')"

          # Fallback: exact patch may be unavailable on the runner (e.g. 18.0 vs 18.6).
          if [ -z "$DESTINATION" ]; then
            REQUESTED_MAJOR="${REQUESTED_IOS%%.*}"
            DESTINATION="$(printf '%s\n' "$SHOW_DESTINATIONS" | awk -F'[{}]' -v major="$REQUESTED_MAJOR" '
              /platform:iOS Simulator/ {
                line = $2
                gsub(/, /, ",", line)
                gsub(/^ +| +$/, "", line)
                if (line ~ ("OS:" major "\\.")) {
                  print line
                  exit
                }
              }
            ')"
          fi

          if [ -z "$DESTINATION" ]; then
            echo "No compatible iOS Simulator runtime found for requested iOS $REQUESTED_IOS."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "destination=$DESTINATION" >> "$GITHUB_OUTPUT"
          echo "Requested iOS: $REQUESTED_IOS"
          echo "Using destination: $DESTINATION"

      - name: Build
        if: steps.destination.outputs.skip != 'true'
        run: |
          xcodebuild \
            -project MeasureMe.xcodeproj \
            -scheme MeasureMe \
            -destination "${{ steps.destination.outputs.destination }}" \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Static Analyze (non-blocking)
        if: steps.destination.outputs.skip != 'true'
        continue-on-error: true
        run: |
          xcodebuild \
            -project MeasureMe.xcodeproj \
            -scheme MeasureMe \
            -destination "${{ steps.destination.outputs.destination }}" \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            analyze

      - name: Test
        if: steps.destination.outputs.skip != 'true'
        run: |
          xcodebuild \
            -project MeasureMe.xcodeproj \
            -scheme MeasureMe \
            -destination "${{ steps.destination.outputs.destination }}" \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            test

      - name: Skip note
        if: steps.destination.outputs.skip == 'true'
        run: |
          echo "Skipped iOS ${{ matrix.ios_runtime }} lane: simulator runtime unavailable on this runner."
